<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VEIL Node Admin</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: #1f2937;
        --accent: #22d3ee;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        color: var(--text);
        background: radial-gradient(900px 600px at 10% -10%, rgba(34, 211, 238, 0.2), transparent), var(--bg);
      }
      main {
        max-width: 920px;
        margin: 0 auto;
        padding: 24px;
      }
      .card {
        background: linear-gradient(160deg, rgba(17, 24, 39, 0.95), rgba(17, 24, 39, 0.75));
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
      }
      h1, h2 { margin: 0 0 10px; }
      .muted { color: var(--muted); }
      input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1324;
        color: var(--text);
      }
      button {
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        background: #0c1a2a;
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, var(--accent), #3b82f6);
        color: #0b1220;
        border: none;
        font-weight: 600;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
      }
      .stat {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        background: rgba(2, 6, 23, 0.55);
      }
      .label { color: var(--muted); font-size: 0.8rem; }
      .value { margin-top: 4px; font-family: ui-monospace, Menlo, Consolas, monospace; }
      #adminPanel { display: none; }
      #status { margin-top: 8px; color: var(--muted); }
      .row { display: flex; gap: 8px; flex-wrap: wrap; }
      table {
        width: 100%;
        border-collapse: collapse;
        font-family: ui-monospace, Menlo, Consolas, monospace;
        font-size: 0.85rem;
      }
      th, td {
        text-align: left;
        border-bottom: 1px solid var(--border);
        padding: 8px 6px;
      }
      th { color: var(--muted); }
    </style>
  </head>
  <body>
    <main>
      <div class="card">
        <h1>VEIL Admin</h1>
        <div class="muted">Login with the VPS node Nostr identity (`nsec` or 32-byte hex secret).</div>
      </div>

      <div class="card" id="loginPanel">
        <h2>Authentication</h2>
        <div class="muted" id="serverPubkey">Server pubkey: loading…</div>
        <input id="secretInput" type="password" placeholder="nsec1... or hex secret" autocomplete="off" />
        <div class="row">
          <button class="primary" id="loginBtn">Login</button>
          <button id="logoutBtn" type="button">Logout</button>
        </div>
        <div id="status">Not authenticated.</div>
      </div>

      <div class="card" id="adminPanel">
        <h2>Admin Stats</h2>
        <div class="grid">
          <div class="stat"><div class="label">Ticks</div><div class="value" id="ticks">-</div></div>
          <div class="stat"><div class="label">Delivered</div><div class="value" id="delivered">-</div></div>
          <div class="stat"><div class="label">Fast Inbound</div><div class="value" id="fastIn">-</div></div>
          <div class="stat"><div class="label">Fallback Inbound</div><div class="value" id="fallbackIn">-</div></div>
          <div class="stat"><div class="label">Fast Outbound Err</div><div class="value" id="fastErr">-</div></div>
          <div class="stat"><div class="label">Fallback Outbound Err</div><div class="value" id="fallbackErr">-</div></div>
          <div class="stat"><div class="label">Nostr Events</div><div class="value" id="nostrEvents">-</div></div>
          <div class="stat"><div class="label">Nostr Bytes</div><div class="value" id="nostrBytes">-</div></div>
          <div class="stat"><div class="label">Peers</div><div class="value" id="peers">-</div></div>
        </div>
      </div>

      <div class="card" id="settingsPanel" style="display: none;">
        <h2>Node Settings</h2>
        <div class="muted">Changes are persisted immediately, but most settings apply after node restart.</div>
        <div style="margin-top: 10px;" class="row">
          <input id="settingKeyInput" type="text" placeholder="VEIL_VPS_..." style="flex: 1; min-width: 260px;" />
          <input id="settingValueInput" type="text" placeholder="value" style="flex: 2; min-width: 260px;" />
        </div>
        <div class="row">
          <button class="primary" id="saveSettingBtn">Save setting</button>
          <button id="deleteSettingBtn" type="button">Delete setting</button>
          <button id="refreshSettingsBtn" type="button">Refresh list</button>
        </div>
        <div id="settingsStatus" class="muted" style="margin-top: 8px;">Idle.</div>
        <div style="margin-top: 10px; max-height: 320px; overflow: auto;">
          <table>
            <thead>
              <tr><th>Key</th><th>Value</th></tr>
            </thead>
            <tbody id="settingsTableBody"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      const serverPubkeyEl = document.getElementById("serverPubkey");
      const statusEl = document.getElementById("status");
      const adminPanelEl = document.getElementById("adminPanel");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const secretInput = document.getElementById("secretInput");
      const settingsPanelEl = document.getElementById("settingsPanel");
      const settingKeyInput = document.getElementById("settingKeyInput");
      const settingValueInput = document.getElementById("settingValueInput");
      const saveSettingBtn = document.getElementById("saveSettingBtn");
      const deleteSettingBtn = document.getElementById("deleteSettingBtn");
      const refreshSettingsBtn = document.getElementById("refreshSettingsBtn");
      const settingsStatusEl = document.getElementById("settingsStatus");
      const settingsTableBody = document.getElementById("settingsTableBody");

      function token() {
        return localStorage.getItem("veil_admin_token") || "";
      }

      function parseMetricsText(text) {
        const out = {};
        for (const rawLine of text.split("\n")) {
          const line = rawLine.trim();
          if (!line || line.startsWith("#")) continue;
          const parts = line.split(/\s+/);
          if (parts.length >= 2) out[parts[0]] = parts[1];
        }
        return out;
      }

      async function fetchAdmin(path) {
        return fetch(path, {
          headers: { Authorization: `Bearer ${token()}` },
          cache: "no-store",
        });
      }

      function setLoggedIn(isLoggedIn) {
        adminPanelEl.style.display = isLoggedIn ? "block" : "none";
        settingsPanelEl.style.display = isLoggedIn ? "block" : "none";
      }

      async function refreshStatus() {
        try {
          const res = await fetchAdmin("/admin-api/status");
          const body = await res.json();
          serverPubkeyEl.textContent = `Server pubkey: ${body.server_pubkey || "unknown"}`;
          const ok = Boolean(body.ok);
          setLoggedIn(ok);
          statusEl.textContent = ok ? "Authenticated." : "Not authenticated.";
          if (ok) {
            await refreshAdminStats();
            await refreshSettingsList();
          }
        } catch (_) {
          statusEl.textContent = "Status check failed.";
        }
      }

      function renderSettings(items) {
        settingsTableBody.innerHTML = "";
        for (const item of items) {
          const tr = document.createElement("tr");
          const keyTd = document.createElement("td");
          const valueTd = document.createElement("td");
          keyTd.textContent = item[0];
          valueTd.textContent = item[1];
          tr.appendChild(keyTd);
          tr.appendChild(valueTd);
          tr.addEventListener("click", () => {
            settingKeyInput.value = item[0];
            settingValueInput.value = item[1];
          });
          settingsTableBody.appendChild(tr);
        }
      }

      async function refreshSettingsList() {
        settingsStatusEl.textContent = "Loading settings…";
        const res = await fetchAdmin("/admin-api/settings");
        const body = await res.json().catch(() => ({}));
        if (!res.ok || !body.ok || !Array.isArray(body.items)) {
          settingsStatusEl.textContent = body.error || "Failed to load settings.";
          return;
        }
        renderSettings(body.items);
        settingsStatusEl.textContent = `Loaded ${body.items.length} settings.`;
      }

      async function refreshAdminStats() {
        const [metricsRes, peersRes] = await Promise.all([
          fetchAdmin("/admin-api/metrics"),
          fetchAdmin("/admin-api/peers?limit=1000"),
        ]);
        if (!metricsRes.ok || !peersRes.ok) {
          statusEl.textContent = "Admin data fetch failed.";
          return;
        }
        const metrics = parseMetricsText(await metricsRes.text());
        const peersCount = (await peersRes.text())
          .split("\n")
          .map((v) => v.trim())
          .filter((v) => v.length > 0).length;

        document.getElementById("ticks").textContent = metrics.veil_ticks_total || "-";
        document.getElementById("delivered").textContent = metrics.veil_delivered_total || "-";
        document.getElementById("fastIn").textContent = metrics.veil_fast_inbound || "-";
        document.getElementById("fallbackIn").textContent = metrics.veil_fallback_inbound || "-";
        document.getElementById("fastErr").textContent = metrics.veil_fast_outbound_err || "-";
        document.getElementById("fallbackErr").textContent = metrics.veil_fallback_outbound_err || "-";
        document.getElementById("nostrEvents").textContent = metrics.veil_nostr_bridge_events_total || "0";
        document.getElementById("nostrBytes").textContent = metrics.veil_nostr_bridge_payload_bytes_total || "0";
        document.getElementById("peers").textContent = String(peersCount);
      }

      loginBtn.addEventListener("click", async () => {
        const secret = secretInput.value.trim();
        if (!secret) {
          statusEl.textContent = "Enter the node identity secret first.";
          return;
        }
        statusEl.textContent = "Logging in…";
        const res = await fetch("/admin-api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ secret }),
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok || !body.ok || !body.token) {
          statusEl.textContent = body.error || "Login failed.";
          setLoggedIn(false);
          return;
        }
        localStorage.setItem("veil_admin_token", body.token);
        secretInput.value = "";
        statusEl.textContent = "Authenticated.";
        await refreshStatus();
      });

      logoutBtn.addEventListener("click", async () => {
        try {
          await fetch("/admin-api/logout", {
            method: "POST",
            headers: { Authorization: `Bearer ${token()}` },
          });
        } catch (_) {
          // best-effort server logout
        }
        localStorage.removeItem("veil_admin_token");
        setLoggedIn(false);
        statusEl.textContent = "Logged out.";
      });

      saveSettingBtn.addEventListener("click", async () => {
        const key = settingKeyInput.value.trim();
        const value = settingValueInput.value.trim();
        if (!key) {
          settingsStatusEl.textContent = "Key is required.";
          return;
        }
        settingsStatusEl.textContent = "Saving…";
        const res = await fetch("/admin-api/settings", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token()}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ key, value }),
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok || !body.ok) {
          settingsStatusEl.textContent = body.error || "Save failed.";
          return;
        }
        settingsStatusEl.textContent = `Saved ${key}.`;
        await refreshSettingsList();
      });

      deleteSettingBtn.addEventListener("click", async () => {
        const key = settingKeyInput.value.trim();
        if (!key) {
          settingsStatusEl.textContent = "Key is required.";
          return;
        }
        settingsStatusEl.textContent = "Deleting…";
        const res = await fetch(`/admin-api/settings?key=${encodeURIComponent(key)}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token()}` },
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok || !body.ok) {
          settingsStatusEl.textContent = body.error || "Delete failed.";
          return;
        }
        settingValueInput.value = "";
        settingsStatusEl.textContent = `Deleted ${key}.`;
        await refreshSettingsList();
      });

      refreshSettingsBtn.addEventListener("click", async () => {
        await refreshSettingsList();
      });

      refreshStatus();
      setInterval(() => {
        if (adminPanelEl.style.display === "block") {
          refreshAdminStats().catch(() => {});
        }
      }, 5000);
    </script>
  </body>
</html>
