<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VEIL Node Admin</title>
    <link rel="icon" href="../veil_logo.png" />
    <link rel="stylesheet" href="../style.css" />
    <style>
      :root {
        --sidebar-width: 240px;
      }

      body {
        display: flex;
        min-height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(20px);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 24px 0;
        z-index: 100;
      }

      .sidebar-brand {
        padding: 0 24px 32px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-item {
        padding: 12px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-muted);
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
        border-left: 3px solid transparent;
        font-weight: 500;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-main);
      }

      .nav-item.active {
        background: rgba(34, 211, 238, 0.1);
        color: var(--secondary);
        border-left-color: var(--secondary);
      }

      /* Main Content */
      .main-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      header.admin-header {
        flex-shrink: 0;
        height: 72px;
        padding: 0 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.3);
      }

      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-out;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Stats Grid */
      .admin-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }

      .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 20px;
      }

      /* Login Overlay */
      #loginOverlay {
        position: fixed;
        inset: 0;
        background: var(--bg-dark);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      .login-card {
        width: 100%;
        max-width: 400px;
      }

      /* Log Viewer */
      .log-viewer {
        background: rgba(0, 0, 0, 0.4);
        border-radius: var(--radius-md);
        padding: 16px;
        font-family: ui-monospace, monospace;
        font-size: 0.8rem;
        height: 500px;
        overflow-y: auto;
        border: 1px solid var(--border);
      }

      .log-entry {
        margin-bottom: 4px;
        display: flex;
        gap: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        padding-bottom: 2px;
      }

      .log-time { color: var(--text-muted); min-width: 80px; }
      .log-level { font-weight: 700; width: 50px; }
      .log-level-ERROR { color: var(--error); }
      .log-level-WARN { color: #fbbf24; }
      .log-level-INFO { color: var(--success); }
      .log-target { color: var(--secondary); opacity: 0.7; }

      /* Settings Table */
      .settings-table {
        width: 100%;
        border-collapse: collapse;
      }

      .settings-table th {
        text-align: left;
        padding: 12px;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border);
        font-size: 0.85rem;
      }

      .settings-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        font-family: ui-monospace, monospace;
        font-size: 0.85rem;
      }

      .settings-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
        cursor: pointer;
      }

      .toggle-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 22px;
      }

      .switch input { opacity: 0; width: 0; height: 0; }

      .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: #334155;
        transition: .2s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .2s;
        border-radius: 50%;
      }

      input:checked + .slider { background-color: var(--secondary); }
      input:checked + .slider:before { transform: translateX(22px); }
    </style>
  </head>
  <body>
    <!-- Login Modal -->
    <div id="loginOverlay">
      <div class="card login-card text-center">
        <img src="../veil_logo.png" height="48" style="margin-bottom: 24px;">
        <h2>Admin Login</h2>
        <p class="text-muted text-small mb-4">Authenticate with the node identity secret.</p>
        
        <div id="serverPubkeyLogin" class="font-mono text-small mb-4" style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; word-break: break-all;">
          Loading server pubkey...
        </div>

        <input id="secretInput" type="password" placeholder="nsec1... or hex secret" class="mb-4">
        
        <button class="btn btn-primary w-full" id="loginBtn">Login</button>
        <div id="loginStatus" class="text-small mt-2 text-muted">Not authenticated.</div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <img src="../veil_logo.png" height="24">
        <span style="font-weight: 700; letter-spacing: 0.05em;">ADMIN</span>
      </div>
      
      <nav>
        <a class="nav-item active" data-tab="dashboard">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Dashboard
        </a>
        <a class="nav-item" data-tab="settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </a>
        <a class="nav-item" data-tab="logs">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Logs
        </a>
        <a class="nav-item" data-tab="nostr">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
          Nostr
        </a>
        <a class="nav-item" data-tab="policy">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Policy
        </a>
        <a class="nav-item" data-tab="identity">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Identity
        </a>
      </nav>

      <div style="margin-top: auto; padding: 0 24px;">
        <button class="btn btn-secondary w-full" id="logoutBtn">Logout</button>
      </div>
    </aside>

    <!-- Main Wrapper -->
    <div class="main-wrapper">
      <header class="admin-header">
        <div class="flex items-center gap-4">
          <div class="badge badge-blue">Server Online</div>
          <div class="text-small text-muted font-mono" id="currentPubkeyHeader">...</div>
        </div>
        <div class="flex items-center gap-4">
          <button class="btn btn-sm btn-secondary" id="restartNodeBtn">Restart Node</button>
          <a href="/" class="btn btn-sm btn-secondary">Go to Site</a>
        </div>
      </header>

      <div class="content-area">
        <!-- Dashboard Tab -->
        <section id="dashboard" class="tab-content active">
          <h2>Node Statistics</h2>
          <div class="admin-stats mb-4">
            <div class="stat-card">
              <div class="text-muted text-small">Total Delivered</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);" id="ticks">-</div>
            </div>
            <div class="stat-card">
              <div class="text-muted text-small">In-memory Delivered</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="delivered">-</div>
            </div>
            <div class="stat-card">
              <div class="text-muted text-small">Nostr Bridged</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="nostrEvents">-</div>
            </div>
            <div class="stat-card">
              <div class="text-muted text-small">Peers</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="peers">-</div>
            </div>
          </div>

          <div class="grid grid-2">
            <div class="card">
              <h3>Inbound Traffic</h3>
              <div class="flex justify-between font-mono mb-4">
                <span class="text-muted">Fast (QUIC)</span>
                <span id="fastIn">0</span>
              </div>
              <div class="flex justify-between font-mono">
                <span class="text-muted">Fallback</span>
                <span id="fallbackIn">0</span>
              </div>
            </div>
            <div class="card">
              <h3>Error Rates</h3>
              <div class="flex justify-between font-mono mb-4">
                <span class="text-muted">Fast Outbound</span>
                <span id="fastErr" class="text-error">0</span>
              </div>
              <div class="flex justify-between font-mono">
                <span class="text-muted">Fallback Outbound</span>
                <span id="fallbackErr" class="text-error">0</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings Tab -->
        <section id="settings" class="tab-content">
          <div class="flex justify-between items-center mb-4">
            <h2>Node Configuration</h2>
            <button class="btn btn-sm btn-secondary" id="refreshSettingsBtn">Refresh List</button>
          </div>

          <div class="card">
            <h3>Quick Toggles</h3>
            <p class="text-muted text-small mb-4">Boolean settings applied after restart.</p>
            <div id="toggleSettingsList" class="grid grid-2" style="gap: 16px;">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="card">
            <h3>Environment Overrides</h3>
            <div class="grid grid-2 mb-4" style="gap: 16px;">
              <input id="settingKeyInput" type="text" placeholder="VEIL_VPS_KEY">
              <input id="settingValueInput" type="text" placeholder="Value">
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary" id="saveSettingBtn">Save Override</button>
              <button class="btn btn-secondary" id="deleteSettingBtn">Delete</button>
            </div>
            <div id="settingsStatus" class="text-small text-muted mt-2">Idle.</div>

            <div class="mt-4" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm);">
              <table class="settings-table">
                <thead><tr><th>Key</th><th>Value</th></tr></thead>
                <tbody id="settingsTableBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Logs Tab -->
        <section id="logs" class="tab-content">
          <div class="flex justify-between items-center mb-4">
            <h2>Server Logs</h2>
            <button class="btn btn-sm btn-primary" id="refreshLogsBtn">Refresh Logs</button>
          </div>
          <div id="logsStatus" class="text-small text-muted mb-2">Idle.</div>
          <div id="logsList" class="log-viewer">
            <!-- Populated by JS -->
          </div>
        </section>

        <!-- Nostr Tab -->
        <section id="nostr" class="tab-content">
          <h2>Nostr Bridge</h2>
          <p class="text-muted text-small mb-4">Bridged Nostr events are automatically published to the VEIL network using the node's identity.</p>
          
          <div class="card mb-4">
            <div id="nostrToggleContainer">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="card">
            <h3>Relay Management</h3>
            <p class="text-muted text-small mb-4">Configure the Nostr relays this node subscribes to for event ingestion.</p>
            
            <div class="flex gap-2 mb-4">
              <input id="relayInput" type="text" placeholder="wss://relay.example.com">
              <button class="btn btn-primary" id="addRelayBtn">Add Relay</button>
            </div>

            <div id="relayList" class="flex flex-col gap-2">
              <div class="text-muted text-small">Loading relays...</div>
            </div>
            
            <div id="nostrStatus" class="text-small text-muted mt-4">Bridge settings require a node restart to take effect.</div>
          </div>
        </section>

        <!-- Policy Tab -->
        <section id="policy" class="tab-content">
          <h2>Web-of-Trust Policy</h2>
          <p class="text-muted text-small mb-4">Manage trust tiers for publishers. Higher trust tiers receive higher forwarding quotas and larger storage budgets.</p>
          
          <div class="admin-stats mb-4">
            <div class="stat-card">
              <div class="text-muted text-small">Trusted</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="policyTrusted">-</div>
            </div>
            <div class="stat-card">
              <div class="text-muted text-small">Muted</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700; color: #fbbf24;" id="policyMuted">-</div>
            </div>
            <div class="stat-card">
              <div class="text-muted text-small">Blocked</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700; color: var(--error);" id="policyBlocked">-</div>
            </div>
            <div class="stat-card">
              <div class="text-muted text-small">Endorsements</div>
              <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="policyEndorsements">-</div>
            </div>
          </div>

          <div class="card">
            <h3>Manage Pubkey</h3>
            <div class="flex gap-2 mb-4">
              <input id="policyPubkeyInput" type="text" placeholder="64-char hex pubkey">
              <select id="policyActionSelect" class="btn btn-secondary" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white;">
                <option value="trust">Trust</option>
                <option value="untrust">Untrust</option>
                <option value="mute">Mute</option>
                <option value="unmute">Unmute</option>
                <option value="block">Block</option>
                <option value="unblock">Unblock</option>
              </select>
              <button class="btn btn-primary" id="applyPolicyBtn">Apply</button>
            </div>
            <div id="policyStatus" class="text-small text-muted">Ready.</div>
          </div>
        </section>

        <!-- Identity Tab -->
        <section id="identity" class="tab-content">
          <h2>Server Identity</h2>
          <div class="card">
            <div class="badge badge-orange mb-4">Sensitive Data</div>
            <p class="text-muted text-small mb-4">Keep this secret offline. This key controls the node's network identity and encryption path.</p>
            
            <div class="mb-4">
              <div class="text-small text-muted mb-2">Nostr Secret (nsec)</div>
              <div class="flex gap-2">
                <input id="serverNsec" type="password" readonly class="font-mono">
                <button class="btn btn-secondary btn-sm" id="copyNsecBtn">Copy</button>
              </div>
            </div>

            <div class="mb-4">
              <div class="text-small text-muted mb-2">Secret Key (Hex)</div>
              <div class="flex gap-2">
                <input id="serverHex" type="password" readonly class="font-mono">
                <button class="btn btn-secondary btn-sm" id="copyHexBtn">Copy</button>
              </div>
            </div>
            
            <div id="identityStatus" class="text-small text-muted">Securely loaded.</div>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Navigation
      const navItems = document.querySelectorAll('.nav-item');
      const tabContents = document.querySelectorAll('.tab-content');

      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const tabId = item.getAttribute('data-tab');
          
          navItems.forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
          
          tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === tabId) content.classList.add('active');
          });
        });
      });

      // API Logic
      const serverPubkeyLoginEl = document.getElementById("serverPubkeyLogin");
      const currentPubkeyHeader = document.getElementById("currentPubkeyHeader");
      const adminPanelEl = document.getElementById("loginOverlay");
      const restartNodeBtn = document.getElementById("restartNodeBtn");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const secretInput = document.getElementById("secretInput");
      const settingKeyInput = document.getElementById("settingKeyInput");
      const settingValueInput = document.getElementById("settingValueInput");
      const saveSettingBtn = document.getElementById("saveSettingBtn");
      const deleteSettingBtn = document.getElementById("deleteSettingBtn");
      const refreshSettingsBtn = document.getElementById("refreshSettingsBtn");
      const settingsStatusEl = document.getElementById("settingsStatus");
      const settingsTableBody = document.getElementById("settingsTableBody");
      const toggleSettingsListEl = document.getElementById("toggleSettingsList");
      const logsListEl = document.getElementById("logsList");
      const refreshLogsBtn = document.getElementById("refreshLogsBtn");
      const relayInput = document.getElementById("relayInput");
      const addRelayBtn = document.getElementById("addRelayBtn");
      const relayListEl = document.getElementById("relayList");
      const nostrToggleContainer = document.getElementById("nostrToggleContainer");
      const serverNsecEl = document.getElementById("serverNsec");
      const serverHexEl = document.getElementById("serverHex");
      const identityStatusEl = document.getElementById("identityStatus");
      const copyNsecBtn = document.getElementById("copyNsecBtn");
      const copyHexBtn = document.getElementById("copyHexBtn");

      const policyTrustedEl = document.getElementById("policyTrusted");
      const policyMutedEl = document.getElementById("policyMuted");
      const policyBlockedEl = document.getElementById("policyBlocked");
      const policyEndorsementsEl = document.getElementById("policyEndorsements");
      const policyPubkeyInput = document.getElementById("policyPubkeyInput");
      const policyActionSelect = document.getElementById("policyActionSelect");
      const applyPolicyBtn = document.getElementById("applyPolicyBtn");
      const policyStatusEl = document.getElementById("policyStatus");

      const TOGGLE_SETTINGS = [
        { key: "VEIL_VPS_OPEN_RELAY", label: "Open Relay", group: "Network", description: "Accept all tags/peers.", defaultValue: false, restartRequired: true },
        { key: "VEIL_VPS_NOSTR_BRIDGE_ENABLED", label: "Nostr Bridge", group: "Nostr", description: "Ingest Nostr events.", defaultValue: false, restartRequired: true },
        { key: "VEIL_VPS_ADAPTIVE_LANE_SCORING", label: "Adaptive Lane Scoring", group: "Network", description: "Auto-tune preference.", defaultValue: true, restartRequired: true },
        { key: "VEIL_VPS_PROBABILISTIC_FORWARDING", label: "Probabilistic Forwarding", group: "Network", description: "Reduce floods.", defaultValue: true, restartRequired: true },
        { key: "VEIL_VPS_BLOOM_EXCHANGE", label: "Bloom Exchange", group: "Transport", description: "Filter shard dedupe.", defaultValue: true, restartRequired: true },
      ];
      let latestSettingsMap = {};

      function token() { return localStorage.getItem("veil_admin_token") || ""; }

      async function fetchAdmin(path) {
        return fetch(path, {
          headers: { Authorization: `Bearer ${token()}` },
          cache: "no-store",
        });
      }

      function setLoggedIn(isLoggedIn) {
        adminPanelEl.style.display = isLoggedIn ? "none" : "flex";
      }

      async function refreshStatus() {
        try {
          const res = await fetchAdmin("/admin-api/status");
          const body = await res.json();
          const pubkey = body.server_pubkey || "unknown";
          serverPubkeyLoginEl.textContent = `Server: ${pubkey}`;
          currentPubkeyHeader.textContent = pubkey.substring(0, 16) + '...';
          const ok = Boolean(body.ok);
          setLoggedIn(ok);
          if (ok) {
            await refreshAdminStats();
            await refreshSettingsList();
            await refreshIdentityExport();
            await refreshLogs();
            await refreshPolicySummary();
          }
        } catch (_) {
          console.error("Status check failed");
        }
      }

      async function refreshPolicySummary() {
        try {
          const res = await fetchAdmin("/admin-api/policy");
          if (!res.ok) return;
          const body = await res.json();
          policyTrustedEl.textContent = body.trusted ?? "-";
          policyMutedEl.textContent = body.muted ?? "-";
          policyBlockedEl.textContent = body.blocked ?? "-";
          policyEndorsementsEl.textContent = body.endorsements ?? "-";
        } catch (err) {
          console.error("Failed to refresh policy summary:", err);
        }
      }

      applyPolicyBtn.addEventListener("click", async () => {
        const pubkey = policyPubkeyInput.value.trim();
        const action = policyActionSelect.value;
        if (!pubkey || pubkey.length !== 64) {
          alert("Enter a valid 64-character hex pubkey.");
          return;
        }
        
        policyStatusEl.textContent = `Applying ${action} to ${pubkey.substring(0,8)}...`;
        try {
          const res = await fetch(`/admin-api/policy/${action}`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token()}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ pubkey_hex: pubkey }),
          });
          if (res.ok) {
            policyStatusEl.textContent = `Successfully applied ${action}.`;
            policyPubkeyInput.value = "";
            await refreshPolicySummary();
          } else {
            const body = await res.json().catch(() => ({}));
            policyStatusEl.textContent = body.error || `Failed to apply ${action}.`;
          }
        } catch (err) {
          policyStatusEl.textContent = "Network error while applying policy.";
        }
      });

      async function refreshIdentityExport() {
        const res = await fetchAdmin("/admin-api/identity");
        const body = await res.json().catch(() => ({}));
        if (!res.ok || !body.ok) return;
        serverNsecEl.value = body.server_secret_nsec || "-";
        serverHexEl.value = body.server_secret_hex || "-";
      }

      function renderNostrTab() {
        // 1. Render Toggle
        const config = TOGGLE_SETTINGS.find(s => s.key === "VEIL_VPS_NOSTR_BRIDGE_ENABLED");
        nostrToggleContainer.innerHTML = "";
        if (config) {
          const div = document.createElement("div");
          div.className = "toggle-item";
          
          const info = document.createElement("div");
          info.innerHTML = `<div style="font-weight:600;">${config.label}</div><div class="text-small text-muted">${config.description}</div>`;
          
          const label = document.createElement("label");
          label.className = "switch";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.checked = parseBoolValue(latestSettingsMap[config.key], config.defaultValue);
          
          input.addEventListener("change", async () => {
            const newValue = input.checked ? "1" : "0";
            const res = await upsertSetting(config.key, newValue);
            if (res.ok) {
              await refreshSettingsList();
            } else {
              input.checked = !input.checked;
              alert("Failed to update bridge status");
            }
          });

          const slider = document.createElement("span");
          slider.className = "slider";
          label.appendChild(input);
          label.appendChild(slider);
          
          div.appendChild(info);
          div.appendChild(label);
          nostrToggleContainer.appendChild(div);
        }

        // 2. Render Relays
        const relayStr = latestSettingsMap["VEIL_VPS_NOSTR_BRIDGE_RELAYS"] || "";
        const relays = relayStr.split(',').map(r => r.trim()).filter(r => r.length > 0);
        
        relayListEl.innerHTML = "";
        if (relays.length === 0) {
          relayListEl.innerHTML = '<div class="text-muted text-small">No relays configured in database overrides. Node is using defaults or is empty.</div>';
        } else {
          for (const relay of relays) {
            const div = document.createElement("div");
            div.className = "flex justify-between items-center p-2";
            div.style.background = "rgba(255,255,255,0.03)";
            div.style.borderRadius = "8px";
            div.style.padding = "10px 16px";
            div.style.border = "1px solid var(--border)";
            
            const relayText = document.createElement("div");
            relayText.className = "font-mono text-small";
            relayText.textContent = relay;

            const removeBtn = document.createElement("button");
            removeBtn.className = "btn btn-secondary btn-sm";
            removeBtn.textContent = "Remove";
            removeBtn.onclick = () => window.removeRelay(relay);
            
            div.appendChild(relayText);
            div.appendChild(removeBtn);
            relayListEl.appendChild(div);
          }
        }
      }

      window.removeRelay = async function(url) {
        const relayStr = latestSettingsMap["VEIL_VPS_NOSTR_BRIDGE_RELAYS"] || "";
        const relays = relayStr.split(',').map(r => r.trim()).filter(r => r.length > 0);
        const filtered = relays.filter(r => r !== url);
        const newValue = filtered.join(',');
        
        const res = await upsertSetting("VEIL_VPS_NOSTR_BRIDGE_RELAYS", newValue);
        if (res.ok) {
          await refreshSettingsList();
        } else {
          alert("Failed to remove relay");
        }
      };

      addRelayBtn.addEventListener("click", async () => {
        const url = relayInput.value.trim();
        if (!url) return;
        if (!url.startsWith("ws://") && !url.startsWith("wss://")) {
          alert("Relay URL must start with ws:// or wss://");
          return;
        }
        
        const relayStr = latestSettingsMap["VEIL_VPS_NOSTR_BRIDGE_RELAYS"] || "";
        const relays = relayStr.split(',').map(r => r.trim()).filter(r => r.length > 0);
        if (relays.includes(url)) {
          relayInput.value = "";
          return;
        }
        
        relays.push(url);
        const newValue = relays.join(',');
        const res = await upsertSetting("VEIL_VPS_NOSTR_BRIDGE_RELAYS", newValue);
        if (res.ok) {
          relayInput.value = "";
          await refreshSettingsList();
        } else {
          alert("Failed to add relay");
        }
      });

      function renderSettings(items) {
        latestSettingsMap = {};
        settingsTableBody.innerHTML = "";
        for (const item of items) {
          const tr = document.createElement("tr");
          const keyTd = document.createElement("td");
          const valueTd = document.createElement("td");
          latestSettingsMap[item[0]] = item[1];
          keyTd.textContent = item[0];
          valueTd.textContent = item[1];
          tr.appendChild(keyTd);
          tr.appendChild(valueTd);
          tr.addEventListener("click", () => {
            settingKeyInput.value = item[0];
            settingValueInput.value = item[1];
          });
          settingsTableBody.appendChild(tr);
        }
        renderToggleSettings();
        renderNostrTab();
      }

      function parseBoolValue(rawValue, defaultValue) {
        if (rawValue == null) return defaultValue;
        const v = String(rawValue).trim().toLowerCase();
        if (["1", "true", "yes", "on", "enabled"].includes(v)) return true;
        if (["0", "false", "no", "off", "disabled"].includes(v)) return false;
        return defaultValue;
      }

      async function upsertSetting(key, value) {
        return fetch("/admin-api/settings", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token()}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ key, value }),
        });
      }

      function renderToggleSettings() {
        toggleSettingsListEl.innerHTML = "";
        for (const config of TOGGLE_SETTINGS) {
          const div = document.createElement("div");
          div.className = "toggle-item";
          
          const info = document.createElement("div");
          info.innerHTML = `<div style="font-weight:600;">${config.label}</div><div class="text-small text-muted">${config.description}</div>`;
          
          const label = document.createElement("label");
          label.className = "switch";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.checked = parseBoolValue(latestSettingsMap[config.key], config.defaultValue);
          
          input.addEventListener("change", async () => {
            const newValue = input.checked ? "1" : "0";
            const res = await upsertSetting(config.key, newValue);
            if (res.ok) await refreshSettingsList();
          });

          const slider = document.createElement("span");
          slider.className = "slider";
          label.appendChild(input);
          label.appendChild(slider);
          
          div.appendChild(info);
          div.appendChild(label);
          toggleSettingsListEl.appendChild(div);
        }
      }

      async function refreshSettingsList() {
        const res = await fetchAdmin("/admin-api/settings");
        const body = await res.json().catch(() => ({}));
        if (res.ok && body.ok && Array.isArray(body.items)) {
          renderSettings(body.items);
        }
      }

      function parseMetricsText(text) {
        const out = {};
        for (const rawLine of text.split("\n")) {
          const line = rawLine.trim();
          if (!line || line.startsWith("#")) continue;
          const parts = line.split(/\s+/);
          if (parts.length >= 2) out[parts[0]] = parts[1];
        }
        return out;
      }

      async function refreshAdminStats() {
        const [metricsRes, peersRes] = await Promise.all([
          fetchAdmin("/admin-api/metrics"),
          fetchAdmin("/admin-api/peers?limit=1000"),
        ]);
        if (!metricsRes.ok || !peersRes.ok) return;
        const metrics = parseMetricsText(await metricsRes.text());
        const peersCount = (await peersRes.text()).split("\n").filter(v => v.trim()).length;

        document.getElementById("ticks").textContent = Number(metrics.veil_delivered_total || 0).toLocaleString();
        document.getElementById("delivered").textContent = Number(metrics.veil_delivered_total || 0).toLocaleString();
        document.getElementById("fastIn").textContent = metrics.veil_fast_inbound || "0";
        document.getElementById("fallbackIn").textContent = metrics.veil_fallback_inbound || "0";
        document.getElementById("fastErr").textContent = metrics.veil_fast_outbound_err || "0";
        document.getElementById("fallbackErr").textContent = metrics.veil_fallback_outbound_err || "0";
        document.getElementById("nostrEvents").textContent = metrics.veil_nostr_bridge_events_total || "0";
        document.getElementById("peers").textContent = String(peersCount);
      }

      async function refreshLogs() {
        try {
          const res = await fetchAdmin("/admin-api/logs");
          const body = await res.json().catch(() => ({}));
          if (res.ok && body.ok && Array.isArray(body.logs)) {
            renderLogs(body.logs);
          }
        } catch (err) {}
      }

      function renderLogs(logs) {
        logsListEl.innerHTML = "";
        for (const entry of logs) {
          const div = document.createElement("div");
          div.className = "log-entry";
          const timeStr = new Date(entry.timestamp).toISOString().split('T')[1].split('Z')[0];
          div.innerHTML = `<span class="log-time">${timeStr}</span><span class="log-level log-level-${entry.level}">${entry.level}</span><span class="log-target">${entry.target}</span><span>${entry.message}</span>`;
          logsListEl.appendChild(div);
        }
        logsListEl.scrollTop = logsListEl.scrollHeight;
      }

      loginBtn.addEventListener("click", async () => {
        const secret = secretInput.value.trim();
        if (!secret) return;
        const res = await fetch("/admin-api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ secret }),
        });
        const body = await res.json().catch(() => ({}));
        if (res.ok && body.ok && body.token) {
          localStorage.setItem("veil_admin_token", body.token);
          secretInput.value = "";
          await refreshStatus();
        } else {
          document.getElementById("loginStatus").textContent = body.error || "Login failed.";
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await fetch("/admin-api/logout", { method: "POST", headers: { Authorization: `Bearer ${token()}` } }).catch(() => {});
        localStorage.removeItem("veil_admin_token");
        setLoggedIn(false);
      });

      saveSettingBtn.addEventListener("click", async () => {
        const key = settingKeyInput.value.trim();
        const value = settingValueInput.value.trim();
        if (!key) return;
        const res = await upsertSetting(key, value);
        if (res.ok) {
          settingsStatusEl.textContent = `Saved ${key}.`;
          await refreshSettingsList();
        }
      });

      deleteSettingBtn.addEventListener("click", async () => {
        const key = settingKeyInput.value.trim();
        if (!key) return;
        const res = await fetch(`/admin-api/settings?key=${encodeURIComponent(key)}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token()}` },
        });
        if (res.ok) {
          settingValueInput.value = "";
          await refreshSettingsList();
        }
      });

      refreshSettingsBtn.addEventListener("click", refreshSettingsList);
      refreshLogsBtn.addEventListener("click", refreshLogs);
      copyNsecBtn.addEventListener("click", () => { navigator.clipboard.writeText(serverNsecEl.value); identityStatusEl.textContent = "Copied!"; });
      copyHexBtn.addEventListener("click", () => { navigator.clipboard.writeText(serverHexEl.value); identityStatusEl.textContent = "Copied!"; });

      restartNodeBtn.addEventListener("click", async () => {
        if (confirm("Restart Node?")) {
          const res = await fetch("/admin-api/restart", { method: "POST", headers: { Authorization: `Bearer ${token()}` } });
          if (res.ok) alert("Restart requested.");
        }
      });

      refreshStatus();
      setInterval(() => { if (token()) refreshAdminStats(); }, 5000);
    </script>
  </body>
</html>
