<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VEIL VPS Node</title>
    <link rel="icon" href="veil_logo.png" />
    <link rel="stylesheet" href="style.css" />
    <script defer src="qrcode.min.js"></script>
    <style>
      .post-card {
        background: rgba(2, 6, 23, 0.4);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: 100%;
      }
      .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
      }
      .post-author {
        color: var(--secondary);
        font-family: ui-monospace, monospace;
        font-weight: 600;
      }
      .post-text {
        font-size: 0.95rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        flex-grow: 1;
      }
      .post-footer {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: auto;
        border-top: 1px solid var(--border);
        padding-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="text-center" style="padding: 48px 0 32px;">
        <div class="badge badge-blue" style="margin-bottom: 16px;">VEIL VPS Node</div>
        <h1>Privacy-Preserving<br/>Shard-Native Feeds</h1>
        <p class="text-muted" style="max-width: 600px; margin: 0 auto;">
          This node helps the VEIL network stay resilient by forwarding opaque shards across multiple transports.
        </p>
      </header>

      <main class="grid">
        <!-- Status Overview -->
        <section class="card">
          <div class="flex justify-between items-center mb-4">
            <h3>Node Status</h3>
            <div class="flex items-center gap-2">
               <span id="healthDot" class="status-dot"></span>
               <span id="healthText" class="text-small text-muted">Connecting...</span>
            </div>
          </div>
          
          <div class="grid grid-4" style="gap: 16px;">
             <div>
               <div class="text-muted text-small">Delivered</div>
               <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="deliveredValue">-</div>
             </div>
             <div>
               <div class="text-muted text-small">Ticks</div>
               <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="ticksValue">-</div>
             </div>
             <div>
               <div class="text-muted text-small">Peers</div>
               <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="peersValue">-</div>
             </div>
             <div>
               <div class="text-muted text-small">Bridged Events</div>
               <div class="font-mono" style="font-size: 1.5rem; font-weight: 700;" id="nostrEventsValue">-</div>
             </div>
          </div>
  
          <div class="grid grid-2 mt-2" style="margin-top: 24px; gap: 16px;">
             <div class="p-4" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px;">
                <div class="text-small text-muted" style="margin-bottom: 8px;">Traffic (Inbound)</div>
                <div class="flex justify-between font-mono text-small">
                  <span>Fast (QUIC)</span> <span id="fastInValue">-</span>
                </div>
                <div class="flex justify-between font-mono text-small" style="margin-top: 4px;">
                  <span>Fallback</span> <span id="fallbackInValue">-</span>
                </div>
             </div>
             <div class="p-4" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px;">
                <div class="text-small text-muted" style="margin-bottom: 8px;">Bridge Health</div>
                <div class="flex justify-between font-mono text-small">
                  <span>Rate</span> <span><span id="nostrRateValue">-</span>/min</span>
                </div>
                <div class="flex justify-between font-mono text-small" style="margin-top: 4px;">
                  <span>Payload</span> <span><span id="nostrAvgValue">-</span> B/ev</span>
                </div>
             </div>
          </div>
          <div class="text-small text-muted text-center" style="margin-top: 16px;" id="statsStatus">Waiting for data...</div>
        </section>
  
        <!-- Live Feed -->
        <section class="card">
          <div class="flex justify-between items-center mb-4">
             <h3>Live Feed</h3>
             <span class="badge badge-orange">Public</span>
          </div>
          <div id="postsList" class="grid grid-3" style="gap: 16px;">
             <div class="text-muted text-small">Waiting for posts...</div>
          </div>
        </section>
  
        <!-- Onboarding -->
        <section class="card">
          <div class="grid grid-2" style="gap: 32px;">
             <div style="display: flex; flex-direction: column; align-items: center;">
                <h3>Connect App</h3>
                <p class="text-muted text-small mb-4 text-center">
                  Scan to import connection profile.
                </p>
                <div id="qr" style="background: white; padding: 12px; border-radius: 12px; width: 224px; height: 224px;"></div>
                <button id="copyProfile" class="btn btn-primary mt-2" style="width: 224px; margin-top: 16px;">
                   Copy Profile Link
                </button>
             </div>
             <div class="flex flex-col justify-between">
                <div>
                  <h3>Endpoints</h3>
                  <div class="mb-4">
                    <div class="text-small text-muted" style="margin-bottom: 6px;">WebSocket</div>
                    <input type="text" id="wsEndpoint" readonly onclick="this.select()">
                  </div>
                  <div class="mb-4">
                    <div class="text-small text-muted" style="margin-bottom: 6px;">QUIC</div>
                    <input type="text" id="quicEndpoint" readonly onclick="this.select()">
                    <div class="text-small text-muted" style="margin-top: 4px; font-size: 0.75rem;">QUIC uses certificate pinning. Accept the server cert in-app.</div>
                  </div>
                </div>
                <div class="flex gap-2">
                   <a href="/admin/" class="btn btn-secondary w-full">Open Admin Dashboard</a>
                </div>
             </div>
          </div>
        </section>
      </main>
      
      <footer class="text-center text-muted text-small" style="padding-bottom: 32px;">
        Powered by VEIL — shard‑native, privacy‑preserving delivery.
      </footer>
    </div>

    <script src="config.js"></script>
    <script>
      const host = window.location.host;
      const isSecure = window.location.protocol === "https:";
      const ws = `${isSecure ? "wss" : "ws"}://${host}/ws`;
      const quicPort = window.VEIL_VPS_QUIC_PORT || 5000;
      const quicCertB64 = window.VEIL_VPS_QUIC_CERT_B64 || "";
      const quicAlpn = window.VEIL_VPS_QUIC_ALPN || "";
      const quic = `quic://${host.split(":")[0]}:${quicPort}`;
      const params = new URLSearchParams({ ws, quic });
      if (quicCertB64) {
        params.set("certb64", quicCertB64);
      }
      if (quicAlpn) {
        params.set("alpn", quicAlpn);
      }
      const profile = `veil://vps?${params.toString()}`;

      document.getElementById("wsEndpoint").value = ws;
      document.getElementById("quicEndpoint").value = quic;

      const qrTarget = document.getElementById("qr");
      function renderQr() {
        if (typeof QRCode === "undefined") {
          qrTarget.textContent = "QR unavailable.";
          return;
        }
        qrTarget.innerHTML = "";
        new QRCode(qrTarget, {
          text: profile,
          width: 200,
          height: 200,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M,
        });
      }
      if (document.readyState === "complete") {
        renderQr();
      } else {
        window.addEventListener("load", renderQr);
      }

      document.getElementById("copyProfile").addEventListener("click", async () => {
        await navigator.clipboard.writeText(profile);
        alert("Profile URL copied.");
      });

      const healthDot = document.getElementById("healthDot");
      const healthText = document.getElementById("healthText");
      
      const peersEl = document.getElementById("peersValue");
      const ticksEl = document.getElementById("ticksValue");
      const deliveredEl = document.getElementById("deliveredValue");
      const fastInEl = document.getElementById("fastInValue");
      const fallbackInEl = document.getElementById("fallbackInValue");
      const nostrEventsEl = document.getElementById("nostrEventsValue");
      const nostrRateEl = document.getElementById("nostrRateValue");
      const nostrAvgEl = document.getElementById("nostrAvgValue");
      const statsStatusEl = document.getElementById("statsStatus");
      const postsListEl = document.getElementById("postsList");
      let lastNostrSample = null;

      function fmtInt(value) {
        return Number.isFinite(value) ? Math.round(value).toLocaleString() : "-";
      }

      function renderPosts(posts) {
        if (!posts || posts.length === 0) {
          postsListEl.innerHTML = '<div class="text-muted text-small text-center" style="grid-column: 1/-1;">No public posts yet.</div>';
          return;
        }
        
        postsListEl.innerHTML = '';
        // Only take the last 6 posts
        const recent = posts.slice(0, 6);
        
        for (const post of recent) {
          // Supports "post" kind in FeedBundle
          if (post.kind !== 'post') continue;
          
          const card = document.createElement('div');
          card.className = 'post-card';
          
          const header = document.createElement('div');
          header.className = 'post-header';
          
          const author = document.createElement('span');
          author.className = 'post-author';
          const pubkey = post.author_pubkey_hex || 'unknown';
          author.textContent = pubkey.substring(0, 8);
          author.title = pubkey;
          
          const channel = document.createElement('span');
          channel.className = 'badge badge-blue';
          channel.textContent = `#${post.channel_id || 'general'}`;
          
          header.appendChild(author);
          header.appendChild(channel);
          
          const text = document.createElement('div');
          text.className = 'post-text';
          const content = post.text || '';
          text.textContent = content.length > 140 ? content.substring(0, 140) + '...' : content;
          
          const footer = document.createElement('div');
          footer.className = 'post-footer';
          const date = new Date(post.meta.created_at * 1000);
          footer.textContent = date.toLocaleString();
          
          card.appendChild(header);
          card.appendChild(text);
          card.appendChild(footer);
          postsListEl.appendChild(card);
        }
        
        if (postsListEl.children.length === 0) {
          postsListEl.innerHTML = '<div class="text-muted text-small text-center" style="grid-column: 1/-1;">No public posts found.</div>';
        }
      }

      async function fetchText(path) {
        const res = await fetch(path, { cache: "no-store" });
        return {
          ok: res.ok,
          status: res.status,
          text: await res.text(),
        };
      }

      async function pollPosts() {
        try {
          const res = await fetchText("/latest-posts");
          if (res.ok) {
            const body = JSON.parse(res.text);
            renderPosts(body.posts);
          }
        } catch (err) {
          // Silent fail for feed
        }
      }

      function parseMetricsText(text) {
        const out = {};
        for (const rawLine of text.split("\n")) {
          const line = rawLine.trim();
          if (!line || line.startsWith("#")) continue;
          const parts = line.split(/\s+/);
          if (parts.length >= 2) out[parts[0]] = parts[1];
        }
        return out;
      }

      async function pollStats() {
        try {
          pollPosts();
          const [health, metrics, peers] = await Promise.all([
            fetchText("/health"),
            fetchText("/metrics"),
            fetchText("/peers?limit=1000"),
          ]);

          if (health.ok && health.text.trim().toLowerCase().includes("ok")) {
            healthDot.className = "status-dot ok";
            healthText.textContent = "Online";
          } else if (health.status === 401 || health.status === 403) {
            healthDot.className = "status-dot warn";
            healthText.textContent = "Auth Required";
          } else {
            healthDot.className = "status-dot error";
            healthText.textContent = "Degraded";
          }

          if (metrics.ok) {
            const m = parseMetricsText(metrics.text);
            ticksEl.textContent = fmtInt(Number(m.veil_ticks_total));
            deliveredEl.textContent = fmtInt(Number(m.veil_delivered_total));
            fastInEl.textContent = fmtInt(Number(m.veil_fast_inbound));
            fallbackInEl.textContent = fmtInt(Number(m.veil_fallback_inbound));
            
            const totalEvents = Number(m.veil_nostr_bridge_events_total || "0");
            const totalBytes = Number(m.veil_nostr_bridge_payload_bytes_total || "0");
            nostrEventsEl.textContent = fmtInt(totalEvents);
            
            if (totalEvents > 0) {
              nostrAvgEl.textContent = fmtInt(totalBytes / totalEvents);
            } else {
              nostrAvgEl.textContent = "0";
            }
            
            const nowMs = Date.now();
            if (
              lastNostrSample &&
              Number.isFinite(totalEvents) &&
              totalEvents >= lastNostrSample.events &&
              nowMs > lastNostrSample.timestampMs
            ) {
              const deltaEvents = totalEvents - lastNostrSample.events;
              const deltaSecs = (nowMs - lastNostrSample.timestampMs) / 1000;
              nostrRateEl.textContent = deltaSecs > 0 ? fmtInt((deltaEvents / deltaSecs) * 60) : "0";
            } else {
              nostrRateEl.textContent = "0";
            }
            lastNostrSample = { events: totalEvents, timestampMs: nowMs };
          } 

          if (peers.ok) {
            const count = peers.text
              .split("\n")
              .map((v) => v.trim())
              .filter((v) => v.length > 0).length;
            peersEl.textContent = String(count);
          }

          const ts = new Date().toLocaleTimeString();
          statsStatusEl.textContent = `Last updated ${ts}`;
        } catch (err) {
          healthDot.className = "status-dot error";
          healthText.textContent = "Unreachable";
          statsStatusEl.textContent = "Connection lost.";
        }
      }

      pollStats();
      setInterval(pollStats, 5000);
    </script>
  </body>
</html>
